{% extends "layout.html" %}

{% block title %}ServeSYNC - Log Hours{% endblock %}

{% block content %}
<main class="login-dashboard">
  <div class="left-column">
    <div class="section form-card">
      <h2 class="center-text">Log Your Service Hours</h2>
      <form action="/submit-hours" method="post" class="floating-form" autocomplete="off">
        <div class="form-group">
            <i class="fas fa-calendar-alt"></i>
            <input type="date" name="date" id="date" required placeholder=" ">
            <label for="date">Date of Activity</label>
        </div>
        <div class="form-group">
          <i class="fas fa-tasks"></i>
          <input type="text" name="activity" id="activity" required placeholder=" " maxlength="30">
          <label for="activity">Activity Name</label>
        </div>
        <div class="form-group autocomplete-group" style="position: relative;">
          <i class="fas fa-users"></i>
          <input type="text" id="group" name="group" required placeholder=" ">
          <label for="group">Group</label>
          <ul id="group-suggestions" class="autocomplete-list"></ul>
        </div>
        <div class="form-group autocomplete-group" style="position: relative;">
          <i class="fas fa-user-tie"></i>
          <input type="text" name="person_in_charge" id="person_in_charge" required placeholder=" ">
          <label for="person_in_charge">Person in Charge</label>
          <ul id="staff-suggestions" class="autocomplete-list"></ul>
        </div>
        <div class="form-group">
          <i class="fas fa-clock"></i>
          <input type="number" name="hours" id="hours" required step="0.5" min="0" max="24" placeholder=" ">
          <label for="hours">Hours Completed</label>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            {% if category.startswith('logpage-') %}
              <div id="confirmation-message" class="flash-message {{ category }}">
                {{ message }}
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endwith %}
        <button type="submit" class="login-btn">
          <span class="btn-text">Submit Hours</span>
          <span class="btn-loader" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i>
          </span>
        </button>
      </form>
    </div>
  </div>
  <div class="right-column">
    <div class="info-box">
      <h3>Need Help?</h3>
      <p>Make sure you enter your hours truthfully. Contact your teacher if you're unsure.</p>
    </div>
  </div>
</main>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const dateInput = document.getElementById("date");
    if (dateInput) {
      const today = new Date();
      const localDate = today.toLocaleDateString('en-CA'); // formats as YYYY-MM-DD
      dateInput.setAttribute("max", localDate);
      dateInput.value = localDate;
    }

    // Confirmation message animation with auto-dismiss
    const confirmation = document.getElementById("confirmation-message");
    if (confirmation) {
      confirmation.classList.add("show");
      confirmation.scrollIntoView({ behavior: "smooth" });
      setTimeout(() => {
        confirmation.style.opacity = "0";
        setTimeout(() => confirmation.remove(), 500);
      }, 5000);
    }

    // Form validation and submit animation
    const form = document.querySelector("form");
    if (form) {
      form.addEventListener("submit", (e) => {
        const hoursInput = document.getElementById("hours");
        const hours = parseFloat(hoursInput.value);
        if (hours <= 0) {
          e.preventDefault();
          alert("Hours must be greater than 0.");
          return;
        }

        const btnText = form.querySelector(".btn-text");
        const btnLoader = form.querySelector(".btn-loader");
        if (btnText && btnLoader) {
          btnText.style.display = "none";
          btnLoader.style.display = "inline-block";
        }
      });
    }

    const groupInput = document.getElementById("group");
    const suggestionBox = document.getElementById("group-suggestions");

    let timeout;
    groupInput.addEventListener("input", () => {
      clearTimeout(timeout);
      const query = groupInput.value.trim();
      if (!query) {
        suggestionBox.innerHTML = "";
        return;
      }
      timeout = setTimeout(() => {
        fetch(`/api/groups?q=${encodeURIComponent(query)}`)
          .then(res => res.json())
          .then(groups => {
            suggestionBox.innerHTML = "";
            groups.forEach(group => {
              const li = document.createElement("li");
              li.textContent = group;
              li.addEventListener("click", () => {
                groupInput.value = group;
                suggestionBox.innerHTML = "";

                // Fetch and populate the staff member linked to this group
                fetch(`/api/staff-for-group?group=${encodeURIComponent(group)}`)
                  .then(res => res.json())
                  .then(staff => {
                    const personSelect = document.getElementById("person_in_charge");
                    personSelect.value = "";
                    personSelect.setAttribute("data-linked-staff-value", "");
                    personSelect.setAttribute("data-linked-staff-label", "");

                    // Add the default auto-selected staff linked to the group
                    if (staff && staff.label) {
                      personSelect.value = staff.label;
                      personSelect.setAttribute("data-linked-staff-value", staff.value);
                      personSelect.setAttribute("data-linked-staff-label", staff.label);
                    }
                  });
              });
              suggestionBox.appendChild(li);
            });
          });
      }, 200);
    });

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".autocomplete-group")) {
        suggestionBox.innerHTML = "";
      }
    });

    const staffInput = document.getElementById("person_in_charge");
    const staffBox = document.getElementById("staff-suggestions");

    let staffTimeout;
    staffInput.addEventListener("input", () => {
      clearTimeout(staffTimeout);
      const query = staffInput.value.trim().toLowerCase();
      if (!query) {
        staffBox.innerHTML = "";
        return;
      }
      staffTimeout = setTimeout(() => {
        fetch(`/api/all-staff`)
          .then(res => res.json())
          .then(staffList => {
            staffBox.innerHTML = "";
            staffList.forEach(staff => {
              if (staff.label.toLowerCase().includes(query)) {
                const li = document.createElement("li");
                li.textContent = staff.label;
                li.addEventListener("click", () => {
                  staffInput.value = staff.label;
                  staffBox.innerHTML = "";
                });
                staffBox.appendChild(li);
              }
            });
          });
      }, 200);
    });

    document.addEventListener("click", (e) => {
      if (!e.target.closest("#person_in_charge")) {
        staffBox.innerHTML = "";
      }
    });
  });
</script>
{% endblock %}