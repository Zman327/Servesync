{% extends "layout.html" %}

{% block title %}ServeSYNC - Log Hours{% endblock %}

{% block content %}
<main class="dashboard">
  <div class="left-column">
    <div class="section form-card">
      <h2 class="center-text">Log Your Service Hours</h2>
      <form action="/submit-hours" method="post" class="floating-form">
        <div class="form-group">
            <i class="fas fa-calendar-alt"></i>
            <input type="date" name="date" id="date" required placeholder=" ">
            <label for="date">Date of Activity</label>
          </div>
        <div class="form-group autocomplete-group" style="position: relative;">
          <i class="fas fa-users"></i>
          <input type="text" id="group" name="group" required placeholder=" ">
          <label for="group">Group</label>
          <ul id="group-suggestions" class="autocomplete-list"></ul>
        </div>
        <div class="form-group">
            <i class="fas fa-user-tie"></i>
            <select name="person_in_charge" id="person_in_charge" required>
                <option value="" disabled selected></option>
                {% for teacher in staff_members %}
                  <option value="{{ teacher.first_name }} {{ teacher.last_name }} ({{ teacher.school_id }})">
                    {{ teacher.first_name }} {{ teacher.last_name }} ({{ teacher.school_id }})
                  </option>
                {% endfor %}
              </select>
            <label for="person_in_charge">Person in Charge</label>
        </div>
        <div class="form-group">
          <i class="fas fa-tasks"></i>
          <input type="text" name="activity" id="activity" required placeholder=" ">
          <label for="activity">Activity Name</label>
        </div>
        <div class="form-group">
          <i class="fas fa-clock"></i>
          <input type="number" name="hours" id="hours" required step="0.5" min="0" placeholder=" ">
          <label for="hours">Hours Completed</label>
        </div>
        {% if session.success %}
          <div id="confirmation-message">âœ… Your hours have been submitted for review!</div>
        {% endif %}
        <button type="submit" class="login-btn">
          <span class="btn-text">Submit Hours</span>
          <span class="btn-loader" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i>
          </span>
        </button>
      </form>
    </div>
  </div>
  <div class="right-column">
    <div class="info-box">
      <h3>Need Help?</h3>
      <p>Make sure you enter your hours truthfully. Contact your teacher if you're unsure.</p>
    </div>
  </div>
</main>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const dateInput = document.getElementById("date");
    if (dateInput) {
      const today = new Date();
      const localDate = today.toLocaleDateString('en-CA'); // formats as YYYY-MM-DD
      dateInput.setAttribute("max", localDate);
      dateInput.value = localDate;
    }

    // Confirmation message animation
    const confirmation = document.getElementById("confirmation-message");
    if (confirmation) {
      confirmation.classList.add("show");
      confirmation.scrollIntoView({ behavior: "smooth" });
    }

    // Form validation and submit animation
    const form = document.querySelector("form");
    if (form) {
      form.addEventListener("submit", (e) => {
        const hoursInput = document.getElementById("hours");
        const hours = parseFloat(hoursInput.value);
        if (hours <= 0) {
          e.preventDefault();
          alert("Hours must be greater than 0.");
          return;
        }

        const btnText = form.querySelector(".btn-text");
        const btnLoader = form.querySelector(".btn-loader");
        if (btnText && btnLoader) {
          btnText.style.display = "none";
          btnLoader.style.display = "inline-block";
        }
      });
    }

    const groupInput = document.getElementById("group");
    const suggestionBox = document.getElementById("group-suggestions");

    let timeout;
    groupInput.addEventListener("input", () => {
      clearTimeout(timeout);
      const query = groupInput.value.trim();
      if (!query) {
        suggestionBox.innerHTML = "";
        return;
      }
      timeout = setTimeout(() => {
        fetch(`/api/groups?q=${encodeURIComponent(query)}`)
          .then(res => res.json())
          .then(groups => {
            suggestionBox.innerHTML = "";
            groups.forEach(group => {
              const li = document.createElement("li");
              li.textContent = group;
              li.addEventListener("click", () => {
                groupInput.value = group;
                suggestionBox.innerHTML = "";
              });
              suggestionBox.appendChild(li);
            });
          });
      }, 200);
    });

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".autocomplete-group")) {
        suggestionBox.innerHTML = "";
      }
    });
  });
</script>
{% endblock %}